{% extends 'base.html' %}

{% block content %}
<div class="content-area">
    <h2>Pemesanan Villa</h2>
    <form method="POST">
        <div class="form-group">
            <label for="nama">Nama Pemesan</label>
            <input type="text" name="nama" id="nama" placeholder="Nama Lengkap" required>
        </div>

        <div class="form-group">
            <label for="identitas">Nomor Identitas (KTP/SIM)</label>
            <input type="text" name="identitas" id="identitas" placeholder="Contoh: 3201011234560001" required>
        </div>

        <div class="form-group">
            <label for="kamar">Tipe Villa</label>
            <select name="kamar" id="kamar" required>
                <option value="">-- Pilih Tipe Villa --</option>
                <option value="Royal Sunset Villa - 2500000">Royal Sunset Villa (Rp 2.500.000/malam)</option>
                <option value="Ocean Breeze Suite - 1800000">Ocean Breeze Suite (Rp 1.800.000/malam)</option>
                <option value="Garden View Cottage - 1200000">Garden View Cottage (Rp 1.200.000/malam)</option>
                <option value="Tropical Budget Room - 750000">Tropical Budget Room (Rp 750.000/malam)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="no_villa">Nomor Villa</label>
            <select name="no_villa" id="no_villa" required>
                <option value="">Pilih nomor villa</option>
            </select>
        </div>

        <div class="form-group">
            <label for="checkin">Tanggal Check-in</label>
            <input type="date" name="checkin" id="checkin" required>
        </div>

        <div class="form-group">
            <label for="checkout">Tanggal Check-out</label>
            <input type="date" name="checkout" id="checkout" required>
        </div>

        <!-- Total Bayar -->
        <div class="form-group">
            <label for="total_bayar">Total Bayar</label>
            <input type="text" id="total_bayar" readonly placeholder="Rp 0">
        </div>

        <div class="menu-buttons" style="margin-top: 24px;">
            <button type="submit">Pesan Sekarang</button>
        </div>
    </form>
</div>

<script>
    async function fetchAvailableVillas() {
        const tipeVilla = document.getElementById('kamar').value.split(" - ")[0];
        const checkin = document.getElementById('checkin').value;
        const checkout = document.getElementById('checkout').value;
        const noVillaSelect = document.getElementById('no_villa');

        if (!tipeVilla || !checkin || !checkout) {
            noVillaSelect.innerHTML = '<option value="">Pilih nomor villa</option>';
            noVillaSelect.disabled = true;
            return;
        }

        const response = await fetch('/get_available_villas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tipe_villa: tipeVilla, checkin, checkout })
        });

        noVillaSelect.innerHTML = '';
        if (response.ok) {
            const data = await response.json();
            if (data.available_villas.length > 0) {
                data.available_villas.forEach(v => {
                    const option = document.createElement('option');
                    option.value = v;
                    option.textContent = v;
                    noVillaSelect.appendChild(option);
                });
                noVillaSelect.disabled = false;
            } else {
                noVillaSelect.innerHTML = '<option value="">Tidak ada villa tersedia</option>';
                noVillaSelect.disabled = true;
            }
        } else {
            noVillaSelect.innerHTML = '<option value="">Gagal mengambil data</option>';
            noVillaSelect.disabled = true;
        }
    }

    function calculateTotalBayar() {
        const kamarValue = document.getElementById('kamar').value;
        const checkin = new Date(document.getElementById('checkin').value);
        const checkout = new Date(document.getElementById('checkout').value);
        const totalBayarInput = document.getElementById('total_bayar');

        if (!kamarValue || isNaN(checkin) || isNaN(checkout)) {
            totalBayarInput.value = "Rp 0";
            return;
        }

        const parts = kamarValue.split(" - ");
        if (parts.length !== 2) {
            totalBayarInput.value = "Rp 0";
            return;
        }

        const hargaPerMalam = parseInt(parts[1]);
        const lamaInap = (checkout - checkin) / (1000 * 60 * 60 * 24);

        if (lamaInap > 0) {
            const total = hargaPerMalam * lamaInap;
            totalBayarInput.value = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR'
            }).format(total);
        } else {
            totalBayarInput.value = "Rp 0";
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('kamar').addEventListener('change', () => {
            fetchAvailableVillas();
            calculateTotalBayar();
        });

        document.getElementById('checkin').addEventListener('change', () => {
            fetchAvailableVillas();
            calculateTotalBayar();
        });

        document.getElementById('checkout').addEventListener('change', () => {
            fetchAvailableVillas();
            calculateTotalBayar();
        });

        const noVillaSelect = document.getElementById('no_villa');
        noVillaSelect.disabled = true;
        noVillaSelect.innerHTML = '<option value="">Pilih nomor villa</option>';
    });
</script>
{% endblock %}
